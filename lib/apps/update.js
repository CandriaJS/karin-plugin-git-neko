import {b,c}from'../chunk-SWUTSNE3.js';import u,{getPluginInfo,logger,common,restart,config,restartDirect,updatePkg,updateGitPlugin}from'node-karin';async function f(t,e){let s=await updatePkg(e,t);return {data:s.data,status:s.status}}async function P(t,e){let r=await updateGitPlugin(e,t?"git reset --hard HEAD && git pull --rebase":"git pull");return {data:r.data,status:r.status}}var F=u.command(/^#?(?:清语表情|clarity-meme)(?:插件)?(?:(强制|预览版))?更新$/i,async t=>{let e="failed",s="",r=getPluginInfo(b.Plugin_Name)?.type;if(r==="npm"){let n=t.msg.includes("\u9884\u89C8\u7248")?"beta":"latest",o=await f(n,b.Plugin_Name);s=o.data,e=o.status;}else if(r==="git"){let n=t.msg.includes("\u5F3A\u5236"),o=await P(n,b.Plugin_Path);e=o.status,s=o.data;}if(logger.debug(s),await t.bot.sendForwardMsg(t.contact,common.makeForward(JSON.stringify(s).slice(1,-1),t.bot.account.selfId,t.bot.account.name),{news:[{text:`\u66F4\u65B0${b.Plugin_Name}`}],prompt:`\u66F4\u65B0${b.Plugin_Name}`,summary:b.Plugin_Name,source:"\u66F4\u65B0\u63D2\u4EF6"}),e==="ok")try{return await t.reply(`
\u66F4\u65B0\u5B8C\u6210\uFF0C\u5F00\u59CB\u91CD\u542F \u672C\u6B21\u8FD0\u884C\u65F6\u95F4\uFF1A${common.uptime()}`,{at:!0}),await restart(t.selfId,t.contact,t.messageId),!0}catch{await t.reply(`${b.Plugin_Name}\u91CD\u542F\u5931\u8D25\uFF0C\u8BF7\u624B\u52A8\u91CD\u542F\u4EE5\u5E94\u7528\u66F4\u65B0\uFF01`);}return  true},{name:"\u6E05\u8BED\u8868\u60C5:\u66F4\u65B0",priority:-1/0,event:"message",permission:"master"}),T=c.other.autoUpdatePlugin&&u.task("\u81EA\u52A8\u66F4\u65B0\u63D2\u4EF6",c.other.autoUpdatePluginCron,async()=>{let t="",e="failed",s=u.getAllBotList(),r=s[Math.floor(Math.random()*s.length)].index,n=u.getBot(r),o=config.master()[0],y=u.contactFriend(o),m=getPluginInfo(b.Plugin_Name)?.type;if(m==="npm"){let i=await f("latest",b.Plugin_Name);t=i.data,e=i.status;}else if(m==="git"){let i=await P(false,b.Plugin_Path);e=i.status,t=i.data;}if(logger.debug(t),await n.sendForwardMsg(y,common.makeForward(JSON.stringify(t).slice(1,-1),n.account.selfId,n.account.name),{news:[{text:`\u66F4\u65B0${b.Plugin_Name}`}],prompt:`\u66F4\u65B0${b.Plugin_Name}`,summary:b.Plugin_Name,source:"\u66F4\u65B0\u63D2\u4EF6"}),e==="ok")try{return await restartDirect(),!0}catch{logger.error(`${b.Plugin_Name}\u91CD\u542F\u5931\u8D25\uFF0C\u8BF7\u624B\u52A8\u91CD\u542F\u4EE5\u5E94\u7528\u66F4\u65B0\uFF01`);}return  true},{name:b.Plugin_AliasName,log:true});export{T as autoUpdatePlugin,F as update};