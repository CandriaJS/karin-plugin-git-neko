import {a,b,c}from'./chunk-SWUTSNE3.js';import {create_state_id,github}from'git-neko-kit';import E,{redis,karinPathBase,logger}from'node-karin';import L from'node-karin/axios';import {Sequelize,literal,fn,col,Op,DataTypes}from'sequelize';var R={};a(R,{get_base_url:()=>j,get_state_id:()=>q,get_user_id_by_state_id:()=>K});async function q(e){let t=await redis.get(`karin:${b.Plugin_Name}:github:user_id:${e.userId}`);t&&(await redis.del(`karin:${b.Plugin_Name}:github:user_id:${e.userId}`),await redis.del(`karin:${b.Plugin_Name}:github:state_id:${t}`));let r=await create_state_id();return await redis.set(`karin:${b.Plugin_Name}:github:user_id:${e.userId}`,r,{EX:600}),await redis.set(`karin:${b.Plugin_Name}:github:state_id:${r}`,e.userId,{EX:600}),r}async function K(e){return await redis.get(`karin:${b.Plugin_Name}:github:state_id:${e}`)??null}var V=async()=>{let e=["https://blog.cloudflare.com/cdn-cgi/trace","https://developers.cloudflare.com/cdn-cgi/trace","https://hostinger.com/cdn-cgi/trace","https://ahrefs.com/cdn-cgi/trace"];try{let t=await Promise.any(e.map(o=>L.get(o,{responseType:"text"})));return Object.fromEntries(t.data.split(`
`).filter(o=>o.trim()!=="").map(o=>o.split("="))).ip}catch(t){throw new Error(`\u55B5\u545C~ \u83B7\u53D6 IP \u6240\u5728\u5730\u533A\u51FA\u9519: ${t.message}`)}};async function j(){let e,t,r="http://";return e=`${r}${process.env.HTTP_HOST}:${process.env.HTTP_PORT}/git`,t=`${r}${await V()}:${process.env.HTTP_PORT}/git`,{local_url:e,remote_url:t}}var A={};a(A,{add_subscription:()=>de,get_all_subscription:()=>he,get_github:()=>me,get_subscription:()=>fe});var g={};a(g,{base:()=>N,github:()=>k,subscription:()=>I});var N={};a(N,{DataTypes:()=>DataTypes,Op:()=>Op,col:()=>col,fn:()=>fn,literal:()=>literal,sequelize:()=>h});var Z=`${karinPathBase}/${b.Plugin_Name}/data/`,h=new Sequelize({dialect:"sqlite",storage:`${Z}/data.db`,logging:false});try{await h.authenticate(),logger.debug(logger.chalk.bold.cyan(`[${b.Plugin_AliasName}] \u6570\u636E\u5E93\u8FDE\u63A5\u6210\u529F`));}catch(e){logger.error(logger.chalk.bold.cyan(`[${b.Plugin_AliasName}] \u6570\u636E\u5E93\u8FDE\u63A5\u5931\u8D25: ${e}`));}var k={};a(k,{add:()=>ee,get:()=>te,table:()=>P});var P=h.define("github",{user_id:{type:DataTypes.STRING,primaryKey:true,autoIncrement:false,allowNull:false,comment:"\u7528\u6237Id"},state_id:{type:DataTypes.STRING,allowNull:false,comment:"\u7528\u6237\u5BF9\u5E94\u7684\u7684\u72B6\u6001\u7801"},access_token:{type:DataTypes.STRING,allowNull:false,comment:"\u7528\u6237Token"},expires_in:{type:DataTypes.INTEGER,allowNull:true,comment:"Token\u8FC7\u671F\u65F6\u95F4"},refresh_token:{type:DataTypes.STRING,allowNull:true,comment:"\u5237\u65B0Token"},refresh_token_expires_in:{type:DataTypes.INTEGER,allowNull:true,comment:"\u5237\u65B0Token\u8FC7\u671F\u65F6\u95F4"}},{freezeTableName:true,defaultScope:{raw:true}});await P.sync();async function ee({user_id:e,state_id:t,access_token:r,expires_in:o,refresh_token:n,refresh_token_expires_in:i}){e=String(e),t=String(t);let m={user_id:e,state_id:t,access_token:r,expires_in:o,refresh_token:n,refresh_token_expires_in:i};return await P.upsert(m)}async function te(e){return await P.findOne({where:{user_id:e}})}var I={};a(I,{add:()=>re,get:()=>oe,get_all:()=>ne,table:()=>w});var w=h.define("subscription",{id:{type:DataTypes.INTEGER,primaryKey:true,autoIncrement:true,comment:"\u4E3B\u952E"},platform:{type:DataTypes.STRING,allowNull:false,comment:"\u5E73\u53F0\u7C7B\u578B"},owner:{type:DataTypes.STRING,allowNull:false,comment:"\u4ED3\u5E93\u62E5\u6709\u8005"},repo:{type:DataTypes.STRING,allowNull:false,comment:"\u4ED3\u5E93\u540D\u79F0"},event:{type:DataTypes.JSON,allowNull:false,comment:"\u8BA2\u9605\u7C7B\u578B"},bot_id:{type:DataTypes.STRING,allowNull:false,comment:"\u673A\u5668\u4EBAId"},user_id:{type:DataTypes.STRING,allowNull:false,comment:"\u7528\u6237Id"},group_id:{type:DataTypes.STRING,allowNull:false,comment:"\u7FA4\u804AId"}},{freezeTableName:true,defaultScope:{raw:true}});await w.sync();async function re({platform:e,owner:t,repo:r,event:o,bot_id:n,user_id:i,group_id:m}){m=String(m),i=String(i),n=String(n);let x={platform:e,owner:t,repo:r,event:o,bot_id:n,user_id:i,group_id:m};return await w.upsert(x)}async function oe({platform:e,owner:t,repo:r,bot_id:o,user_id:n,group_id:i}){n=String(n),i=String(i);let m={platform:e,owner:t,repo:r,bot_id:o,user_id:n,group_id:i};return await w.findOne({where:m})}async function ne({platform:e,owner:t,repo:r}){let o={platform:e,owner:t,repo:r};return await w.findAll({where:o})}var v={};a(v,{Cfg:()=>S,List:()=>C,Theme:()=>B});var S={};a(S,{helpCfg:()=>M});var M={title:`${b.Plugin_AliasName}\u5E2E\u52A9`,subTitle:b.Plugin_Name,columnCount:3,colWidth:265,theme:"all",style:{fontColor:"#d3bc8e",descColor:"#eee",contBgColor:"rgba(6, 21, 31, .5)",contBgBlur:3,headerBgColor:"rgba(6, 21, 31, .4)",rowBgColor1:"rgba(6, 21, 31, .2)"}};var C={};a(C,{helpList:()=>ie});var ie=[{group:"[]\u5185\u4E3A\u5FC5\u586B\u9879,{}\u5185\u4E3A\u53EF\u9009\u9879"},{group:"\u62D3\u5C55\u547D\u4EE4",list:[]}];var B={};a(B,{getThemeCfg:()=>H,getThemeData:()=>se});var H=()=>{let e=`${b.Plugin_Path}/resources/help/theme`,t=`${e}/main.webp`,r=`${e}/bg.webp`;return {main:t,bg:r,style:M.style}},se=e=>{let t=Object.assign({},e),r=Math.min(5,Math.max(parseInt(t?.colCount?.toString()??"3"),2)),o=Math.min(500,Math.max(100,parseInt(t?.colWidth?.toString()??"265"))),n=Math.min(2500,Math.max(800,r*o+30)),i=H(),m=i.style??{},x=[`
    body { background-image: url(${i.bg}); width: ${n}px; }
    .container { background-image: url(${i.main}); width: ${n}px; }
    .help-table .td, .help-table .th { width: ${100/r}%; }
  `],O=function(...b){let y;return b.forEach(_=>{_!==void 0&&y===void 0&&(y=_);}),y},d=function(b,y,_,z,G){let $=O(m[_],e?.[_],z);G&&($=G($)),x.push(`${b} { ${y}: ${$}; }`);};return d(".help-title,.help-group","color","fontColor","#ceb78b"),d(".help-title,.help-group","text-shadow","fontShadow","none"),d(".help-desc","color","descColor","#eee"),d(".cont-box","background","contBgColor","rgba(43, 52, 61, 0.8)"),d(".cont-box","backdrop-filter","contBgBlur",3,b=>e?.bgBlur===false?"none":`blur(${b}px)`),d(".help-group","background","headerBgColor","rgba(34, 41, 51, .4)"),d(".help-table .tr:nth-child(odd)","background","rowBgColor1","rgba(34, 41, 51, .2)"),d(".help-table .tr:nth-child(even)","background","rowBgColor2","rgba(34, 41, 51, .4)"),{style:`<style>${x.join(`
`)}</style>`,colCount:r}};var D={};a(D,{get_user_refresh_token:()=>le,get_user_token:()=>ae,send_msg:()=>ce,update_user_token:()=>ue});async function ae(e){return (await g.github.get(e))?.access_token}async function le(e){return (await g.github.get(e))?.refresh_token}async function ue(e,t,r,o,n){let i=await g.github.get(e);if(!i)throw new Error("\u55B5\u545C~ \u8BE5\u7528\u6237\u4E0D\u5B58\u5728, \u8DF3\u8FC7\u6570\u636E\u5E93\u6DFB\u52A0");return await g.github.add({user_id:e,state_id:i.state_id,access_token:t,expires_in:r,refresh_token:o,refresh_token_expires_in:n})}async function ce(e,t,r,o){try{let n=E.getBot(t);if(e==="group"){let i=E.contactGroup(r);return await n.sendMsg(i,o)}else if(e==="private"){let i=E.contactFriend(r);return await n.sendMsg(i,o)}else throw new Error("\u55B5\u545C~, \u672A\u77E5\u7684\u6D88\u606F\u7C7B\u578B")}catch(n){logger.error(`\u55B5\u545C~ \u5411${e==="group"?"\u7FA4\u7EC4":"\u79C1\u804A"} ${r} \u53D1\u9001\u6D88\u606F\u65F6\u51FA\u9519\uFF1A`,n);}}function me(e){if(!(c.github.APPID||c.github.PrivateKey||c.github.ClientID||c.github.ClientSecret||c.github.WebhookSecret))throw new Error("\u55B5\u545C~ , \u8BF7\u68C0\u67E5 Github \u914D\u7F6E");try{let t=new github.Base({APP_ID:c.github.APPID,Private_Key:c.github.PrivateKey,Client_ID:c.github.ClientID,Client_Secret:c.github.ClientSecret,WebHook_Secret:c.github.WebhookSecret});if(c.proxy){let{common:r,http:o,https:n,socks:i}=c.proxy;r?t.setProxy({type:"common",address:r}):o?t.setProxy({type:"http",address:o}):n?t.setProxy({type:"https",address:n}):i&&t.setProxy({type:"socks",address:i});}return e&&t.setToken(e),t}catch{throw new Error("\u55B5\u545C~ , \u8BF7\u68C0\u67E5 Github \u914D\u7F6E")}}async function de(e,t,r,o,n,i){return await g.subscription.add({platform:"github",owner:e,repo:t,event:r,bot_id:o,user_id:n,group_id:i})}async function fe(e,t,r,o,n){return await g.subscription.get({platform:"github",owner:e,repo:t,bot_id:r,user_id:o,group_id:n})}async function he(e,t){return await g.subscription.get_all({platform:"github",owner:e,repo:t})}export{R as a,g as b,A as c,v as d,D as e};