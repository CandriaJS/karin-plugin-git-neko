import {c as c$1,a,b as b$1,e}from'./chunk-UBICTORI.js';import {b,d}from'./chunk-SWUTSNE3.js';import {logger,app}from'node-karin';import mt from'node-karin/axios';import at from'express-art-template';import W,{Router}from'node-karin/express';import it from'path';import Z from'body-parser';import {get_relative_time}from'git-neko-kit';import et from'markdown-it';var H=Router();H.get("/version",(t,o)=>{o.status(200).json({code:200,message:"success",data:{name:b.Plugin_Name,version:b.Plugin_Version}});});var q=H;var A=Router(),Q=c$1.get_github(),D=await Q.get_app();A.get("/install",async(t,o)=>{if(!t.query.state)return o.status(400).json({code:400,message:"\u8BF7\u4F20\u5165 state \u53C2\u6570"});let a=t.query.state;o.redirect(await D.create_install_link(a));});A.get("/manger",async(t,o)=>{if(!t.query.state)return o.status(400).json({code:400,message:"\u8BF7\u4F20\u5165 state \u53C2\u6570"});let a=t.query.state;o.redirect(await D.create_config_install_link(a));});var G=A;var V=Router(),Y=c$1.get_github(),T=await Y.get_auth();V.get("/",async(t,o)=>{if(!t.query.code)return o.status(400).json({code:400,message:"\u8BF7\u4F20\u5165 code \u53C2\u6570"});let a$1,s,b;a$1="GitHub \u6388\u6743\u5B89\u88C5";try{let w=t.query.code,d=t.query.state,u=await T.get_token_by_code({code:w}),g=u.data.access_token,k=u.data.expires_in,p=u.data.refresh_token,y=u.data.refresh_token_expires_in,R=await a.get_user_id_by_state_id(d);await b$1.github.add({user_id:R,state_id:d,access_token:g,expires_in:k,refresh_token:p,refresh_token_expires_in:y}),s="\u6388\u6743\u6210\u529F",b="success";}catch(w){logger.error("GitHub \u6388\u6743\u5931\u8D25",w),s="\u6388\u6743\u5931\u8D25, \u8BF7\u7A0D\u540E\u518D\u8BD5\u6216\u8054\u7CFB\u7BA1\u7406\u5458",b="error";}return o.render("auth/get_token",{title:a$1,text:s,icon:b})});V.get("/install",async(t,o)=>{if(!t.query.state)return o.status(400).json({code:400,message:"\u8BF7\u4F20\u5165 state \u53C2\u6570"});let a=t.query.state;return o.redirect(await T.create_auth_link(a))});var B=V;var j=c$1.get_github(),N=Router();N.use(Z.json());N.post("/",async(t,o)=>{try{let a=t.headers["x-hub-signature-256"];if(!a)return o.status(401).json({code:401,message:"\u7B7E\u540D\u9A8C\u8BC1\u5931\u8D25"});let s=t.headers["x-github-event"];if(s==="installation")return logger.warn("\u55B5\u545C~, Github App \u4E8B\u4EF6, \u8DF3\u8FC7\u63A8\u9001");if((await(await j.get_webhook()).check_webhook_signature({signature:a,payload:JSON.stringify(t.body)})).data)logger.debug("\u55B5\u545C~, \u7B7E\u540D\u9A8C\u8BC1\u6210\u529F");else return logger.warn("\u55B5\u545C~, \u7B7E\u540D\u9A8C\u8BC1\u5931\u8D25");let d$1=t.body.repository,u=d$1.full_name,g=d$1.visibility,[k,p]=u.split("/");if(t.body.sender.login.includes("[bot]"))return logger.warn("\u55B5\u545C~, \u5F53\u524D\u4E3Abot\u63A8\u9001, \u8DF3\u8FC7\u63A8\u9001");let y=await c$1.get_all_subscription(k,p);if(y.length===0)return logger.warn("\u55B5\u545C~, \u6CA1\u6709\u627E\u5230\u6B64\u4ED3\u5E93\u7684\u8BA2\u9605, \u8DF3\u8FC7\u63A8\u9001");if(!y.some(l=>l.event.includes(s)))return logger.warn(`\u55B5\u545C~, \u6CA1\u6709\u627E\u5230\u5339\u914D ${s} \u4E8B\u4EF6\u7684\u8BA2\u9605, \u8DF3\u8FC7\u63A8\u9001`);await Promise.all(y.map(async l=>{let x=await e.get_user_token(String(l.user_id));j.setToken(x);}));let R;switch(s){case "push":{let l=t.body.ref.replace("refs/heads/","").trim(),x=t.body.head_commit.id.slice(0,7),m=await(await j.get_commit()).get_commit_info({owner:k,repo:p,sha:x,format:!0});if(!m.data)return logger.warn("\u55B5\u545C~, \u672A\u627E\u5230\u63D0\u4EA4\u4FE1\u606F");let M=await get_relative_time(m.data.commit.committer.date),O=new et({html:!0}).render(m.data.commit.body);R=await d.render("commit/index",{platform:"github",title:"\u66F4\u65B0\u63A8\u9001",commits:[{owner:k,repo:p,branch:l,sha:x,visibility:g,author_avatar:m.data.author.avatar_url,author_name:m.data.author.login,commit_date:M,commit_title:m.data.commit.title,commit_body:O,commit_additions:m.data.stats.additions,commit_deletions:m.data.stats.deletions,commit_files_total:m.data.files.length}]});break}case "pull_request":logger.warn(`\u55B5\u545C~, \u6682\u4E0D\u652F\u6301 ${s} \u4E8B\u4EF6`);break;default:logger.warn(`\u55B5\u545C~, \u4E0D\u652F\u6301\u7684\u4E8B\u4EF6\u7C7B\u578B: ${s}`);return}await Promise.all(y.map(l=>e.send_msg("group",String(l.bot_id),String(l.group_id),R)));}catch(a){logger.error(a);}});var E=N;var $=Router();$.use("/auth",B);$.use("/app",G);$.use("/webhook",E);var C=$;var c=W();c.use((t,o,a)=>{let s=Date.now();o.on("finish",()=>{let b$1=Date.now()-s,w=t.url,d=t.method,u=o.statusCode,g=t.headers["x-forwarded-for"],p=((Array.isArray(g)?g[0]:g)?.split(",")[0].trim()??t.headers["x-real-ip"]??t.socket.remoteAddress)?.toString().replace(/^::ffff:/,"");logger.info(`[${b.Plugin_Name}][${d}] ${w} (\u72B6\u6001\u7801: ${u}, \u8017\u65F6: ${b$1}ms, \u5BA2\u6237\u7AEFIP: ${p})`);}),a();});c.engine("html",at);c.set("view engine","html");c.set("views",`${b.Plugin_Path}/resources`);c.locals.gitLayout=`${b.Plugin_Path}/resources/common/layout/git.html`.replace(/\\/g,"/");c.use("/common",W.static(it.join(b.Plugin_Path,"resources/common")));c.use("/",q);c.use("/github",C);var F=c;var J=async()=>{try{let t=Date.now();return logger.info(logger.chalk.bold.yellow(`[${b.Plugin_AliasName}] \u670D\u52A1\u542F\u52A8\u4E2D...`)),app.use("/git",F),logger.info(logger.chalk.bold.green(`=== [${b.Plugin_AliasName}] \u670D\u52A1\u542F\u52A8\u5B8C\u6210 \u{1F680} ==`)),logger.info(logger.chalk.rgb(145,195,240)(`\u8017\u65F6: ${Date.now()-t}ms`)),logger.info(logger.chalk.rgb(145,195,240)(`\u672C\u5730\u5730\u5740: ${(await a.get_base_url()).local_url}`)),logger.info(logger.chalk.bold.green("===================")),!0}catch(t){return logger.error("\u542F\u52A8\u5931\u8D25:",t.message),true}};await J();var L="\u52A0\u8F7D\u5931\u8D25";try{L=(await mt.get(`https://api.wuliya.cn/api/count?name=${b.Plugin_Name}&type=json`,{timeout:500})).data.data;}catch{logger.error(logger.chalk.red.bold("\u26A0\uFE0F \u8BBF\u95EE\u7EDF\u8BA1\u6570\u636E\u5931\u8D25\uFF0C\u8D85\u65F6\u6216\u7F51\u7EDC\u9519\u8BEF"));}logger.info(logger.chalk.bold.rgb(0,255,0)("========= \u{1F31F}\u{1F31F}\u{1F31F} ========="));logger.info(logger.chalk.bold.blue("\u{1F4E6} \u5F53\u524D\u8FD0\u884C\u73AF\u5883: ")+logger.chalk.bold.white(`${b.Bot_Name}`)+logger.chalk.gray(" | ")+logger.chalk.bold.green("\u{1F3F7}\uFE0F \u8FD0\u884C\u7248\u672C: ")+logger.chalk.bold.white(`V${b.Bot_Version}`)+logger.chalk.gray(" | ")+logger.chalk.bold.yellow("\u{1F4CA} \u8FD0\u884C\u63D2\u4EF6\u603B\u8BBF\u95EE/\u8FD0\u884C\u6B21\u6570: ")+logger.chalk.bold.cyan(L));logger.info(logger.chalk.bold.rgb(255,215,0)(`\u2728 ${b.Plugin_AliasName} `)+logger.chalk.bold.rgb(255,165,0).italic(b.Plugin_Version)+logger.chalk.rgb(255,215,0).bold(" \u8F7D\u5165\u6210\u529F ^_^"));logger.info(logger.chalk.cyan.bold("\u{1F4AC} \u96FE\u91CC\u7684\u5C0F\u7A9D: 272040396"));logger.info(logger.chalk.green.bold("========================="));